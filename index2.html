<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Excel Search Tool</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f4f4f4; }
    h2, h3 { text-align: center; }
    .container { max-width: 800px; margin: auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    input[type="file"], select, button, input[type="text"] {
      display: block; width: 100%; margin-bottom: 15px; padding: 10px; border-radius: 4px; border: 1px solid #ccc;
    }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    td { border: 1px solid #ccc; padding: 10px; background: #fff; }
    .highlight { background-color: yellow; font-weight: bold; }
    .hidden { display: none; }
    .download-buttons { display: flex; gap: 10px; margin-top: 15px; }
    .download-buttons button { flex: 1; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Excel Search Tool</h2>
    <input type="file" id="fileInput" accept=".xlsx,.xls,.xlsm" />

    <select id="searchMode">
      <option value="1">1 keyword</option>
      <option value="2">2 keywords</option>
      <option value="3">3 keywords</option>
      <option value="4">Exact phrase</option>
    </select>

    <div id="keywordInputs"></div>

    <label>Column to search (A-G):</label>
    <select id="searchColumn"></select>

    <label>Column to include in output (A-G):</label>
    <select id="outputColumn"></select>

    <button onclick="processFile()">Search</button>

    <div class="download-buttons hidden" id="downloadSection">
      <button onclick="downloadHTML()">Download HTML</button>
      <button onclick="downloadExcel()">Download Excel</button>
    </div>

    <div id="resultCount"></div>
    <table id="resultTable"></table>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.9/xlsx.full.min.js"></script>
  <script>
    const keywordInputsDiv = document.getElementById("keywordInputs");
    const searchModeSelect = document.getElementById("searchMode");
    const searchColumnSelect = document.getElementById("searchColumn");
    const outputColumnSelect = document.getElementById("outputColumn");

    searchModeSelect.addEventListener("change", renderKeywordInputs);
    renderKeywordInputs();
    populateColumnDropdowns();

    function renderKeywordInputs() {
      const mode = parseInt(searchModeSelect.value);
      keywordInputsDiv.innerHTML = "";
      const label = (mode === 4) ? "Enter exact phrase:" : "Enter keyword #";
      const count = (mode === 4) ? 1 : mode;
      for (let i = 1; i <= count; i++) {
        const input = document.createElement("input");
        input.type = "text";
        input.placeholder = (mode === 4) ? label : `${label} ${i}`;
        input.className = "keyword";
        keywordInputsDiv.appendChild(input);
      }
    }

    function getColumnLetters() {
      return ["A", "B", "C", "D", "E", "F", "G"];
    }

    function populateColumnDropdowns() {
      const cols = getColumnLetters();
      [searchColumnSelect, outputColumnSelect].forEach(select => {
        select.innerHTML = "";
        cols.forEach(letter => {
          const opt = document.createElement("option");
          opt.value = opt.text = letter;
          select.appendChild(opt);
        });
      });
    }

    function columnLetterToIndex(letter) {
      return letter.charCodeAt(0) - 65;
    }

    function formatExcelDate(value) {
      const date = XLSX.SSF.parse_date_code(value);
      if (!date) return value;
      return `${String(date.d).padStart(2, '0')}-${String(date.m).padStart(2, '0')}-${String(date.y).slice(-2)}`;
    }

    function processFile() {
      const file = document.getElementById("fileInput").files[0];
      if (!file) return alert("Please upload an Excel file.");

      const mode = parseInt(searchModeSelect.value);
      const inputs = document.querySelectorAll(".keyword");
      const keywords = Array.from(inputs).map(i => i.value.trim()).filter(k => k);
      if ((mode < 4 && keywords.length !== mode) || (mode === 4 && keywords.length !== 1)) {
        return alert("Please enter correct number of keywords/phrase.");
      }

      const searchColLetter = searchColumnSelect.value;
      const outputColLetter = outputColumnSelect.value;
      if (!searchColLetter || !outputColLetter) {
        return alert("Please select both search and output columns.");
      }

      const reader = new FileReader();
      reader.onload = function (e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: "array" });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

        const searchColIndex = columnLetterToIndex(searchColLetter);
        const outputColIndex = columnLetterToIndex(outputColLetter);

        const results = [];
        const seen = new Set();

        for (let i = 1; i < rows.length; i++) {
          const row = rows[i];
          const cell = row[searchColIndex];
          if (!cell || typeof cell !== "string") continue;

          const matchFound = mode === 4
            ? cell.toLowerCase().includes(keywords[0].toLowerCase())
            : keywords.every(k => cell.toLowerCase().includes(k.toLowerCase()));

          if (matchFound && !seen.has(row.toString())) {
            seen.add(row.toString());
            let highlighted = cell;
            keywords.forEach(k => {
              const regex = new RegExp(k, "gi");
              highlighted = highlighted.replace(regex, match => `<span class='highlight'>${match}</span>`);
            });

            const outputCell = formatCell(row[outputColIndex]);
            const resultRow = [];
            if (searchColIndex === outputColIndex) {
              resultRow.push(highlighted);
            } else {
              resultRow.push(highlighted);
              resultRow.push(outputCell);
            }
            results.push(resultRow);
          }
        }

        displayResults(results);
      };
      reader.readAsArrayBuffer(file);
    }

    function formatCell(value) {
      if (typeof value === "number" && value > 30000 && value < 60000) {
        return formatExcelDate(value);
      }
      return value ?? "";
    }

    function displayResults(results) {
      const table = document.getElementById("resultTable");
      const resultCount = document.getElementById("resultCount");
      table.innerHTML = "";
      resultCount.textContent = `Total filtered results found: ${results.length}`;

      for (const row of results) {
        const tr = document.createElement("tr");
        row.forEach(cell => {
          const td = document.createElement("td");
          td.innerHTML = cell;
          tr.appendChild(td);
        });
        table.appendChild(tr);
      }

      document.getElementById("downloadSection").classList.remove("hidden");
      window.filteredResults = results;
    }

    function downloadHTML() {
      const content = `<!DOCTYPE html><html><head><meta charset='UTF-8'><title>Filtered Results</title>
      <style>body{font-family:Arial;padding:20px;}td{border:1px solid #ccc;padding:10px;}table{width:100%;border-collapse:collapse;}span.highlight{background:yellow;font-weight:bold;}</style>
      </head><body><h2>Filtered Results</h2><table>${
        window.filteredResults.map(row =>
          `<tr>${row.map(cell => `<td>${cell}</td>`).join("")}</tr>`
        ).join("")
      }</table></body></html>`;

      const blob = new Blob([content], { type: "text/html" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "filtered_results.html";
      a.click();
      URL.revokeObjectURL(url);
    }

    function downloadExcel() {
      const wb = XLSX.utils.book_new();
      const wsData = window.filteredResults.map(row =>
        row.map(cell => typeof cell === "string" ? cell.replace(/<[^>]+>/g, '') : cell)
      );
      const ws = XLSX.utils.aoa_to_sheet(wsData);
      XLSX.utils.book_append_sheet(wb, ws, "Filtered");
      XLSX.writeFile(wb, "filtered_results.xlsx");
    }
  </script>
</body>
</html>
